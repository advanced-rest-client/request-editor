<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../request-editor.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <request-editor></request-editor>
      </template>
    </test-fixture>

    <script>
    suite('serializeRequest()', function() {
      let element;
      suiteSetup(function(done) {
        element = fixture('basic');
        flush(() => done());
      });

      const POSTACTIONS = [{
        'source': 'request.body',
        'action': 'assign-variable',
        'enabled': true
      }];

      const PREACTIONS = {
        variables: [{
          enabled: true,
          value: 'test-value',
          variable: 'test-var'
        }]
      };

      const AUTH = {
        type: 'ntlm',
        settings: {
          username: 'test',
          password: 'test-p'
        }
      };

      test('Serializes request with empty values', function() {
        const data = element.serializeRequest();
        assert.equal(data.url, '', 'URL is empty');
        assert.equal(data.method, 'GET', 'Default method is set');
        assert.equal(data.headers, '', 'Headers are empty');
        assert.isFalse(!!data.payload, 'Payload is falsy');
        assert.isUndefined(data.requestActions, 'Request actions are not defined');
        assert.isUndefined(data.responseActions, 'Response actions are not defined');
        assert.isUndefined(data.auth);
      });

      test('Serializes request data', function() {
        element.url = 'test-url';
        element.method = 'test-method';
        element.headers = 'test-headers';
        element.payload = 'test-payload';
        element.requestActions = PREACTIONS;
        element.responseActions = POSTACTIONS;

        const data = element.serializeRequest();
        assert.equal(data.url, 'test-url', 'Url is set');
        assert.equal(data.method, 'test-method', 'Method is set');
        assert.equal(data.headers, 'test-headers', 'Headers are set');
        assert.equal(data.payload, 'test-payload', 'Payload is set');
        assert.isTrue(data.requestActions === PREACTIONS, 'Request actions are set');
        assert.isTrue(data.responseActions === POSTACTIONS, 'Request actions are set');
        assert.isUndefined(data.auth);
      });

      test('Serializes Auth data', function(done) {
        element.url = 'test-url';
        element.method = 'test-method';
        element.headers = 'test-headers';
        element.payload = 'test-payload';
        element.authSettings = AUTH;
        flush(() => {
          const data = element.serializeRequest();
          assert.equal(data.url, 'test-url', 'Url is set');
          assert.equal(data.method, 'test-method', 'Method is set');
          assert.equal(data.headers, 'test-headers: ', 'Headers are set');
          assert.equal(data.payload, 'test-payload', 'Payload is set');
          assert.typeOf(data.auth, 'object', 'Auth is an object');
          assert.equal(data.auth.type, 'ntlm', 'Type is NTLM');
          assert.typeOf(data.auth.settings, 'object', 'Auth settings is an object');
          done();
        });
      });
    });
    </script>
  </body>
</html>
