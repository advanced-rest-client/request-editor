<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../url-input-editor/url-input-editor.html">
<link rel="import" href="../api-headers-editor/api-headers-editor.html">
<link rel="import" href="../http-method-selector/http-method-selector.html">
<link rel="import" href="../http-method-selector/http-method-selector-mini.html">
<link rel="import" href="../api-body-editor/api-body-editor.html">
<link rel="import" href="../variables-editor/variables-editor.html">
<link rel="import" href="../authorization-panel/authorization-panel.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../uuid-generator/uuid-generator.html">
<link rel="import" href="../request-actions-panel/request-actions-panel.html">

<dom-module id="request-editor">
  <template>
    <style>
    :host {
      display: block;
      @apply --request-editor;
    }

    .url-editor {
      @apply --layout-horizontal;
      @apply --request-editor-url-editor;
    }

    url-input-editor {
      @apply --layout-flex;
      @apply --request-editor-url-input-editor;
    }

    .main-action-buttons {
      margin-top: 20px;
      margin-left: 16px;
      @apply --request-editor-main-action-buttons;
    }

    h2 {
      @apply --arc-font-subhead;
    }

    .params-header {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .action-button {
      @apply --action-button;
      @apply --request-editor-main-action-button;
    }

    http-method-selector {
      margin-bottom: 12px;
      @apply --request-editor-method-selector;
    }

    http-method-selector-mini {
      margin-right: 8px;
      @apply --request-editor-method-selector-mini;
    }

    .toggle-icon {
      color: var(--content-action-button-color, rgba(0, 0, 0, 0.74));
      transform: rotateZ(0deg);
      transition: transform 0.3s linear, color 0.25s linear;
    }

    .toggle-icon.opened {
      transform: rotateZ(-180deg);
    }

    .toggle-icon:hover {
      color: var(--content-action-button-color-hover, var(--accent-color, rgba(0, 0, 0, 0.74)));
    }

    [hidden] {
      display: none !important;
    }

    .request-menu {
      margin-top: 9px;
      @apply --request-editor-context-menu;
    }

    .context-menu-icon {
      color: var(--request-editor-context-menu-icon-color, var(--primary-color));
      @apply --request-editor-context-menu-icon;
    }

    .options-menu {
      @apply --request-editor-context-menu-dropdown;
    }

    .editors-container {
      @apply --request-editor-tabs-container;
    }

    paper-tab.iron-selected {
      @apply --request-editor-tab-selected;
    }
    </style>
    <iron-media-query query="(max-width: [[narrowWidth]])" query-matches="{{narrow}}"></iron-media-query>
    <div class="content">
      <template is="dom-if" if="[[!noUrlEditor]]" restamp>
        <template is="dom-if" if="[[narrow]]" restamp>
          <http-method-selector events-target="[[eventsTarget]]" method="{{method}}" is-payload="{{isPayload}}"></http-method-selector>
        </template>
        <div class="url-editor">
          <template is="dom-if" if="[[!narrow]]" restamp>
            <http-method-selector-mini events-target="[[eventsTarget]]" method="{{method}}" is-payload="{{isPayload}}"></http-method-selector-mini>
          </template>
          <url-input-editor events-target="[[eventsTarget]]" auto-validate required value="{{url}}" query-parameters="{{queryModel}}" invalid="{{urlInvalid}}"></url-input-editor>
          <div class="main-action-buttons">
            <paper-button id="sendButton" raised class="action-button" hidden$="[[loadingRequest]]" on-tap="_sendRequest">send</paper-button>
            <paper-button id="abortButton" raised class="action-button" hidden$="[[!loadingRequest]]" on-tap="_abortRequest">abort</paper-button>
          </div>
          <paper-menu-button horizontal-align="right" class="request-menu">
            <paper-icon-button icon="arc:more-vert" slot="dropdown-trigger"></paper-icon-button>
            <paper-listbox slot="dropdown-content" class="options-menu" id="requestMenu">
              <template is="dom-if" if="[[xhrExtension]]">
                <paper-icon-item on-tap="toggleXhr">
                  <span slot="item-icon">
                    <paper-toggle-button checked="{{_useXhrExtension}}"></paper-toggle-button>
                    <paper-tooltip offset="0" animation-delay="200">Toggle send via XHR extension</paper-tooltip>
                  </span>
                  Use XHR extension
                </paper-icon-item>
              </template>
              <paper-icon-item on-tap="saveRequestState">
                <span slot="item-icon">
                  <iron-icon icon="arc:save" class="context-menu-icon"></iron-icon>
                  <paper-tooltip item-icon offset="0" animation-delay="200">Save current request</paper-tooltip>
                </span>
                Save
              </paper-icon-item>
              <paper-icon-item on-tap="clearRequest">
                <span slot="item-icon">
                  <iron-icon icon="arc:clear-all" class="context-menu-icon"></iron-icon>
                  <paper-tooltip item-icon offset="0" animation-delay="200">Clear request data</paper-tooltip>
                </span>
                Clear
              </paper-icon-item>
            </paper-listbox>
          </paper-menu-button>
        </div>
      </template>
      <template is="dom-if" if="[[noUrlEditor]]" restamp>
        <http-method-selector events-target="[[eventsTarget]]" method="{{method}}" is-payload="{{isPayload}}"></http-method-selector>
      </template>
      <section class="params-section">
        <header class="params-header">
          <h2>Parameters</h2>
          <paper-icon-button icon="arc:expand-more" id="toggleParameters" on-tap="toggle" class$="[[_computeToggleIconClass(collapseOpened)]]"></paper-icon-button>
          <paper-tooltip for="toggleParameters" animation-delay="100" position="right" offset="0">[[_computeToggleLabel(collapseOpened)]]</paper-tooltip>
        </header>
        <iron-collapse opened="[[collapseOpened]]">
          <paper-tabs selected="{{selectedTab}}" hidden$="[[!collapseOpened]]">
            <paper-tab>Headers</paper-tab>
            <paper-tab>Authorization</paper-tab>
            <paper-tab hidden$="[[!isPayload]]">Body</paper-tab>
            <paper-tab>Variables</paper-tab>
            <paper-tab>Actions</paper-tab>
          </paper-tabs>
          <iron-pages selected="[[selectedTab]]" selected-attribute="opened" class="editors-container">
            <api-headers-editor
              events-target="[[eventsTarget]]"
              is-payload="{{isPayload}}"
              content-type="{{contentType}}"
              value="{{headers}}"
              on-headers-changed="_headersChanged"
              allow-custom
              allow-disable-params
              allow-hide-optional></api-headers-editor>
            <authorization-panel redirect-uri="[[oauth2RedirectUri]]" settings="{{authSettings}}" http-method="[[method]]" request-url="[[url]]" request-body="[[payload]]"></authorization-panel>
            <api-body-editor events-target="[[eventsTarget]]" content-type="[[contentType]]" value="{{payload}}" opened-editor="0"></api-body-editor>
            <variables-editor></variables-editor>
            <request-actions-panel after-actions="{{responseActions}}" before-actions="{{requestActions}}"></request-actions-panel>
          </iron-pages>
        </iron-collapse>
      </section>
    </div>
    <uuid-generator id="uuid"></uuid-generator>
  </template>
  <script>
  /**
   * An element that renders the UI to create a HTTP request.
   *
   * It produces the following values (as element's properties):
   *
   * - url - the request URL
   * - method - HTTP method
   * - headers - HTTP headers string
   * - payload - Request body. It can be either String,
   * [File](https://developer.mozilla.org/en-US/docs/Web/API/File),
   * ([Blob](https://developer.mozilla.org/en-US/docs/Web/API/Blob/Blob)), or
   * [FormData](https://developer.mozilla.org/en-US/docs/Web/API/FormData).
   * - requestActions - List of request actions as defined in
   * `request-actions-panel` element.
   * - responseActions - List of response actions as defined in
   * `request-actions-panel` element.
   * - queryModel - Model for query parameters
   * - headersModel - Model for headers value (not yet implemented)
   *
   * ## Variables
   *
   * Output of abt of this properties can contain a variables in format `${varName}`.
   * Use
   * [variables-evaluator](https://github.com/advanced-rest-client/variables-evaluator)
   * to evaluate variables to the final output.
   *
   * This element works with
   * [variables-manager](https://github.com/advanced-rest-client/variables-manager)
   * that stores variables in the local datastore. It should be placed anywhere
   * in the DOM. The elements uses browser's events system to communicate.
   *
   * ## Events retargeting
   *
   * The editors listens to varous events related to the request state. By default
   * all of the editors listens on a window object. To limit this, set `eventsTarget`
   * on this element to point an element that will be used as events target.
   * This way it is possible to enclose the request panel in a "tab".
   *
   * The `eventsTarget` property is propagated to the editors.
   *
   * Event fired by this or any of the editors will not stop on the `eventsTarget`
   * element and you are responsible to cancel them if nescesary.
   *
   * ## Accessing request data
   *
   * You can access request data by either accessing corresponding property of the
   * element, by listening for `property-changed` event or by listening for
   * `request-data-changed` custom event.
   *
   * Only the last one bubbles through the DOM.
   *
   * ### Example
   *
   * ```html
   * <request-editor
   *  url="{{requestUrl}}"
   *  on-headers-changed="_headersChangedEvent"></request-editor>
   * ```
   *
   * or
   *
   * ```javascript
   * document.body.addEventListener('request-data-changed', (e) => {
   *  console.log(e.detail);
   * });
   * ```
   *
   * ## Authorization panel
   *
   * Authorization panel renders methods to authorize the user.
   * Detailed documentation for authorization is at
   * https://github.com/advanced-rest-client/authorization-panel
   *
   * To make OAuth2 work properly set `oauth2RedirectUri` property to application
   * redirect URI. User should set this value in in provider's settings.
   *
   * ## Request and response actions
   *
   * Request actions allows to (re)set variables before the request is made.
   * Response actions allows to perform a user defined action when the response is ready.
   * More information can be found here:
   * https://github.com/advanced-rest-client/request-actions-panel
   *
   * ### Styling
   *
   * `<request-editor>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--request-editor` | Mixin applied to the element | `{}`
   * `--request-editor-url-editor` | Mixin applied to a line with the URL editor | `{}`
   * `--arc-font-subhead` | Theme mixin, applied to the section name title | `{}`
   * `--action-button` | Theme mixin, applied to the acction buttons | `{}`
   * `--request-editor-context-menu-icon-color` | Color of an icon in the context
   * menu | `--primary-color`
   * `--request-editor-context-menu-icon` | Mixin applied to an icon in the
   * context menu | `{}`
   * `--request-editor-main-action-buttons` | Mixin applied to the action buttons
   * next to the URL editor | `{}`
   * `--request-editor-url-input-editor` | Mixin applied to the URL editor | `{}`
   * `--request-editor-method-selector` | Mixin applied to the methos selector in
   * narrow view | `{}`
   * `--request-editor-method-selector-mini` | Mixin applied to the methos selector
   * in wide view | `{}`
   * `--request-editor-context-menu` | Mixin applied to the main action context
   *  menu dropdown | `{}`
   * `--request-editor-context-menu-dropdown` | Mixin applied to the main action
   * context menu dropdown container | `{}`
   * `--request-editor-main-action-button` | Mixin applied to the send / abort
   * buttons | `{}`
   * `--request-editor-tabs-container` | Mixin applied to the headers and body
   * editors container | `{}`
   * `--request-editor-tab-selected` | Mixin applied to selected tab | `{}`
   *
   * To style edtors use variables defined in the following elements:
   * - [url-input-editor](https://github.com/advanced-rest-client/url-input-editor)
   * - [headers-editor](https://github.com/advanced-rest-client/headers-editor)
   * - [http-method-selector](https://github.com/advanced-rest-client/http-method-selector)
   * - [payload-editor](https://github.com/advanced-rest-client/payload-editor)
   * - [variables-editor](https://github.com/advanced-rest-client/variables-editor)
   *
   * Also paper elements: `paper-button`, `paper-tab`, and `paper-tabs`
   *
   * @polymer
   * @customElement
   * @memberof UiElements
   * @demo demo/index.html
   * @appliesMixin ArcBehaviors.EventsTargetBehavior
   */
  class RequestEditor extends ArcBehaviors.EventsTargetBehavior(Polymer.Element) {
    static get is() { return 'request-editor';}
    static get properties() {
      return {
        // Selected request tab.
        selectedTab: {
          type: Number,
          value: 0,
          observer: '_refreshPayload'
        },
        // Current content type.
        contentType: {
          type: String,
          notify: true
        },
        // Computed value if the method can carry a payload
        isPayload: {
          type: Boolean,
          notify: true,
          observer: '_isPayloadChanged'
        },
        // Headers for the request.
        headers: {
          type: String,
          notify: true,
          observer: 'notifyRequestChanged'
        },
        // Body for the request
        payload: {
          type: String,
          notify: true,
          observer: 'notifyRequestChanged'
        },
        // Current URL
        url: {
          type: String,
          notify: true,
          observer: 'notifyRequestChanged'
        },
        // Current HTTP method
        method: {
          type: String,
          notify: true,
          observer: 'notifyRequestChanged'
        },
        // Query parameters model generated by the URL editor.
        queryModel: {
          type: Array,
          notify: true
        },
        /**
         * List of request actions to be performed when the response is received
         */
        responseActions: {
          type: Array,
          notify: true,
          observer: 'notifyRequestChanged'
        },
        /**
         * List of request actions to be performed before request is send
         */
        requestActions: {
          type: Array,
          notify: true,
          observer: 'notifyRequestChanged'
        },
        /**
         * If set it will renders the view in the narrow layout.
         */
        narrow: Boolean,
        // A widith below which the `narrow` property will be set to true.
        narrowWidth: {
          type: String,
          value: '768px'
        },
        /**
         * Computed value when the URL change.
         * If not valid form submission won't be possible.
         */
        urlInvalid: {
          type: Boolean,
          notify: true
        },
        /**
         * Removes the URL editor from the DOM.
         * It will also cause that the `url` property will be empty and
         * on events fired by this element.
         */
        noUrlEditor: {
          type: Boolean,
          value: false,
          observer: '_noUrlEditorChanged'
        },
        /**
         * When set it will display the UI to indicate that the request is being
         * send.
         */
        loadingRequest: {
          type: Boolean,
          value: false
        },
        // True if the editor panel is opened
        collapseOpened: {
          type: Boolean,
          value: true
        },
        /**
         * Redirect URL for the OAuth2 authorization.
         * If can be also set by dispatching `oauth2-redirect-url-changed`
         * with `value` property on the `detail` object.
         */
        oauth2RedirectUri: String,
        /**
         * If set then it renders an option in request context menu to
         * toggle to XHR request via the extension.
         * It's only relevant to ARC Chrome app.
         */
        xhrExtension: Boolean,
        /**
         * Current state of XHR toggle button
         */
        _useXhrExtension: {
          type: Boolean,
          observer: '_useXhrExtensionChanged'
        },
        /**
         * Generated request ID when the request is sent. This value is reported
         * in send and abort events
         */
        requestId: String,
        // Current authorization panel settings.
        authSettings: {
          type: Object,
          notify: true
        }
      };
    }

    constructor() {
      super();
      this._sendRequestInner = this._sendRequestInner.bind(this);
      this._authRedirectChanged = this._authRedirectChanged.bind(this);
    }

    _attachListeners(node) {
      this.addEventListener('api-request', this._sendRequestInner);
      node.addEventListener('oauth2-redirect-uri-changed', this._authRedirectChanged);
    }

    _detachListeners(node) {
      this.removeEventListener('api-request', this._sendRequestInner);
      node.removeEventListener('oauth2-redirect-uri-changed', this._authRedirectChanged);
    }

    // Toggles body panel.
    toggle() {
      this.collapseOpened = !this.collapseOpened;
    }
    /**
     * Called each time if any of `method`, `url`, 'payload' or `headers` filed
     * change. Fires the `request-data-changed` custom event with current values
     * of the request.
     */
    notifyRequestChanged() {
      const request = this.serializeRequest();
      this.dispatchEvent(new CustomEvent('request-data-changed', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: request
      }));
    }
    /**
     * Serializes current request data into an object.
     *
     * @return {Object} Request data object with the following keys:
     * - url (can be empty)
     * - method (can be empty)
     * - headers (can be empty)
     * - payload (can be undefined)
     * - auth (can be undefined)
     * - actions (can be undefined)
     * - queryModel (Array)
     */
    serializeRequest() {
      const result = {
        url: this.url || '',
        method: this.method || 'GET',
        headers: this.headers || '',
        payload: this.payload,
        auth: this.authSettings,
        responseActions: this.responseActions,
        requestActions: this.requestActions,
        queryModel: this.queryModel
      };
      return result;
    }
    // Computes class for the toggle's button icon.
    _computeToggleIconClass(opened) {
      let clazz = 'toggle-icon';
      if (opened) {
        clazz += ' opened';
      }
      return clazz;
    }

    _computeToggleLabel(opened) {
      return opened ? 'Hide panel' : 'Show panel';
    }
    /**
     * Handles change to `isPayload` property. Restores payload editor tab
     * if needed.
     */
    _isPayloadChanged(isPayload) {
      if (!isPayload && this.selectedTab === 1) {
        this.selectedTab = 0;
      }
      this.shadowRoot.querySelector('paper-tabs').notifyResize();
    }
    /**
     * Called when the selected tab changes. Refreshes payload editor state
     * (for code mirror) if currently selected.
     */
    _refreshPayload(selectedTab) {
      if (selectedTab === 2) {
        // this.shadowRoot.querySelector('api-body-editor').refresh();
      }
    }
    /**
     * Handles an event dispatched by eny of the child elements.
     * It cancels the even and stops it's propagation and the sends the request
     */
    _sendRequestInner(e) {
      if (e.target === this) {
        return;
      }
      e.preventDefault();
      e.stopPropagation();
      this._sendRequest();
    }
    /**
     * Sends the `api-request` custom event to send the request.
     */
    _sendRequest() {
      const request = this.serializeRequest();
      this.requestId = this.$.uuid.generate();
      request.id = this.requestId;
      this.dispatchEvent(new CustomEvent('api-request', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: request
      }));
    }
    /**
     * Sends the `abort-api-request` custom event to cancel the request.
     */
    _abortRequest() {
      this.dispatchEvent(new CustomEvent('abort-api-request', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          url: this.url,
          id: this.requestId
        }
      }));
    }
    /**
     * Clears the URL value if the URL editor is removed.
     */
    _noUrlEditorChanged(value) {
      if (value) {
        this.set('url', undefined);
      }
    }
    /**
     * Deselects menu item if the URL editor is present.
     */
    _unselectRequestMenu() {
      const menu = this.shadowRoot.querySelector('#requestMenu');
      if (!menu) {
        return;
      }
      menu.selected = undefined;
    }
    /**
     * Toggles state of the use XHR extension toggle button.
     */
    toggleXhr(e) {
      const node = e ? e.composedPath()[0].nodeName.toLowerCase() : '';
      if (node !== 'paper-toggle-button') {
        this._useXhrExtension = !this._useXhrExtension;
      }
      if (e && e.preventDefault) {
        e.preventDefault();
        e.stopPropagation();
      }
      this._unselectRequestMenu();
    }
    /**
     * Fires the `request-use-xhr-changed` custom event to inform about
     * toggle button status change.
     */
    _useXhrExtensionChanged(newValue, oldValue) {
      if (oldValue === undefined) {
        return;
      }
      this.dispatchEvent(new CustomEvent('request-use-xhr-changed', {
        composed: true,
        bubbles: true,
        detail: {
          value: newValue
        }
      }));
    }
    /**
     * Fires cancelable `request-save-state` custom event so the application
     * can save the request object.
     */
    saveRequestState() {
      this.dispatchEvent(new CustomEvent('request-save-state', {
        composed: true,
        bubbles: true,
        cancelable: true
      }));
      this._unselectRequestMenu();
    }
    /**
     * Clears the request properties and sends cancelable `request-clear-state`
     * custom event.
     */
    clearRequest() {
      this.set('url', '');
      this.set('headers', '');
      this.set('payload', '');
      this.set('method', 'GET');
      this.set('responseActions', undefined);
      this.set('requestActions', undefined);
      this.shadowRoot.querySelector('authorization-panel').clear();
      this.selectedTab = 0;
      this.dispatchEvent(new CustomEvent('request-clear-state', {
        composed: true,
        bubbles: true,
        cancelable: true
      }));
      this._unselectRequestMenu();
    }

    _authRedirectChanged(e) {
      this.oauth2RedirectUri = e.detail.value;
    }
    /**
     * Fired when the user request to send current request.
     *
     * This event can be cancelled.
     *
     * @event api-request
     * @param {String} url The request URL. Can be empty string.
     * @param {String} method HTTP method name. Can be empty.
     * @param {String} headers HTTP headers string. Can be empty.
     * @param {String|File|FormData} payload Message body. Can be undefined.
     * @param {Object} auth Always undefined. For future use.
     * @param {String} id Generated UUID for the request.
     * @param {Array<Object>} responseActions - List of response actions
     * @param {Array<Object>} requestActions - List of request actions
     */
    /**
     * Fired when the user request to abort current request.
     *
     * This event can be cancelled.
     *
     * @event abort-api-request
     * @param {String} url The request URL. Can be empty string. Also uit may be
     * different URL that the one used to send the request if the user changed
     * it in between.
     * @param {String} id Generated UUID of the request with `api-request`
     * event.
     */
    /**
     * Event fired when any part of the request data change.
     *
     * @event request-data-changed
     * @param {String} url The request URL. Can be empty string.
     * @param {String} method HTTP method name. Can be empty.
     * @param {String} headers HTTP headers string. Can be empty.
     * @param {String|File|FormData} payload Message body. Can be undefined.
     * @param {Object} auth Always undefined. For future use.
     * @param {Array<Object>} responseActions - List of response actions
     * @param {Array<Object>} requestActions - List of request actions
     */
    /**
     * Fired when the state of the toggle XHR button change.
     * It is fired to inform request controlling element to switch to the XHR
     * extension.
     * `xhrExtension` must be set to display the toggle button.
     *
     * @event request-use-xhr-changed
     * @param {Boolean} value Current state of the toggle button
     */
    /**
     * Fired when the save action has been requested in the UI.
     * This event is cancelable.
     *
     * @event request-save-state
     */
    /**
     * Fired when clear request state option has been selected from the menu.
     *
     * @event request-clear-state
     */
  }
  window.customElements.define(RequestEditor.is, RequestEditor);
  </script>
</dom-module>
